<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Sample illustrating the pass through use case of Web NFC.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>PASS THROUGH USECASE DEMO</title>
    <script>
      // Add a global error event listener early on in the page load, to help ensure that browsers
      // which don't support specific functionality still end up displaying a meaningful message.
      window.addEventListener('error', function(error) {
        if (ChromeSamples && ChromeSamples.setStatus) {
          console.error(error);
          ChromeSamples.setStatus(error.message + ' (Your browser may not support this feature.)');
          error.preventDefault();
        }
      });
    </script>

</head>

<body>


<button id="ledOnButton">scan</button>
<button id="ledOffButton">LedOf</button>

<script src="webapi.ts"></script>

<script>
  var ChromeSamples = {
    log: function() {
      var line = Array.prototype.slice.call(arguments).map(function(argument) {
        return typeof argument === 'string' ? argument : JSON.stringify(argument);
      }).join(' ');

      document.querySelector('#log').textContent += line + '\n';
    },

    clearLog: function() {
      document.querySelector('#log').textContent = '';
    },

    setStatus: function(status) {
      document.querySelector('#status').textContent = status;
    },

    setContent: function(newContent) {
      var content = document.querySelector('#content');
      while(content.hasChildNodes()) {
        content.removeChild(content.lastChild);
      }
      content.appendChild(newContent);
    }
  };
</script>

<h3>Live Output</h3>
<div id="output" class="output">
  <div id="content"></div>
  <div id="status"></div>
  <pre id="log"></pre>
</div>

<script>
  if (/Chrome\/(\d+\.\d+.\d+.\d+)/.test(navigator.userAgent)){
    // Let's log a warning if the sample is not supposed to execute on this
    // version of Chrome.
    if (89 > parseInt(RegExp.$1)) {
      ChromeSamples.setStatus('Warning! Keep in mind this sample has been tested with Chrome ' + 89 + '.');
    }
  }
</script>


<script>
  log = ChromeSamples.log;
  
  if (!("NDEFReader" in window))
    ChromeSamples.setStatus("Web NFC is not available. Use Chrome on Android.");
  </script>
  


<script>

ledOnButton.addEventListener("click", async () =>
    {
      log("User clicked LED ON button");
    

      const ndef = new NDEFReader();
      await ndef.scan();

      
     const permission = await navigator.permissions.query({ name: "nfc" });
      if (permission.state === "granted")
{
      ndef.onreading = event => 
      {

const decoder = new TextDecoder();
for (const record of event.message.records) {
  consoleLog("Record type:  " + record.recordType);
  consoleLog("=== data ===\n" + decoder.decode(record.data));
}

};
} else 
{
console.log("NFC permission not granted");
}

});

ledOffButton.addEventListener("click", async () =>
    {
      log("User clicked LED ON button");

      const ndef = new NDEFReader();
      await ndef.scan();

      
     const permission = await navigator.permissions.query({ name: "nfc" });
      if (permission.state === "granted")
{

// Then, request access to the NFC device
async function requestNfcDevice() {
  const options = { timeout: 20000 };
  try {
    const ndef = await navigator.nfc.requestReader(options);
    return ndef;
  } catch (error) {
    console.error(error);
    return null;
  }
}

// Connect to the NFC device and send APDU commands
async function connectAndSendApduToNfcCard() {
  // Request permission to use the NFC API
  const isNfcPermissionGranted = await requestNfcPermission();
  if (!isNfcPermissionGranted) {
    console.error("NFC permission not granted");
    return;
  }

  // Request access to the NFC device
  const nfcDevice = await requestNfcDevice();
  if (!nfcDevice) {
    console.error("NFC device not found");
    return;
  }

  // Connect to the NFC device
  const nfcReader = new NDEFReader(nfcDevice);
  await nfcReader.connect();

  // Send APDU commands to the NFC card
  const apduCommands = [
    "00A40400040102030400", // Select master file
    
  ];

  for (const command of apduCommands) {
    const apduBuffer = new Uint8Array(Buffer.from(command, "hex"));
    const response = await nfcReader.transceive(apduBuffer);
    console.log(response);
  }

  // Disconnect from the NFC device
  await nfcReader.disconnect();
}

// Call the function to connect and send APDU commands to the NFC card
connectAndSendApduToNfcCard();

} 
    });


    function logCommand(command) {
    var commandLog = document.getElementById("commandLog");
    commandLog.innerHTML += command + "<br>";
    commandLog.scrollTop = commandLog.scrollHeight;
  
  }
  
</script>




  </body>
  </html>

  
  
