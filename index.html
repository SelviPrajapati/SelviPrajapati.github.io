<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Sample illustrating the pass through use case of Web NFC.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>PASS THROUGH USECASE DEMO</title>
    <script>
      // Add a global error event listener early on in the page load, to help ensure that browsers
      // which don't support specific functionality still end up displaying a meaningful message.
      window.addEventListener('error', function(error) {
        if (ChromeSamples && ChromeSamples.setStatus) {
          console.error(error);
          ChromeSamples.setStatus(error.message + ' (Your browser may not support this feature.)');
          error.preventDefault();
        }
      });
    </script>

</head>

<body>


<button id="ledOnButton">scan</button>


<script src="webapi.ts"></script>

<script>
  var ChromeSamples = {
    log: function() {
      var line = Array.prototype.slice.call(arguments).map(function(argument) {
        return typeof argument === 'string' ? argument : JSON.stringify(argument);
      }).join(' ');

      document.querySelector('#log').textContent += line + '\n';
    },

    clearLog: function() {
      document.querySelector('#log').textContent = '';
    },

    setStatus: function(status) {
      document.querySelector('#status').textContent = status;
    },

    setContent: function(newContent) {
      var content = document.querySelector('#content');
      while(content.hasChildNodes()) {
        content.removeChild(content.lastChild);
      }
      content.appendChild(newContent);
    }
  };
</script>

<h3>Live Output</h3>
<div id="output" class="output">
  <div id="content"></div>
  <div id="status"></div>
  <pre id="log"></pre>
</div>

<script>
  if (/Chrome\/(\d+\.\d+.\d+.\d+)/.test(navigator.userAgent)){
    // Let's log a warning if the sample is not supposed to execute on this
    // version of Chrome.
    if (89 > parseInt(RegExp.$1)) {
      ChromeSamples.setStatus('Warning! Keep in mind this sample has been tested with Chrome ' + 89 + '.');
    }
  }
</script>


<script>
  log = ChromeSamples.log;
  
  if (!("NDEFReader" in window))
    ChromeSamples.setStatus("Web NFC is not available. Use Chrome on Android.");
  </script>
  


<script>

ledOnButton.addEventListener("click", async () =>
    {
      log("User clicked LED ON button");
    

      const ndef = new NDEFReader();
      await ndef.scan();

      
     const permission = await navigator.permissions.query({ name: "nfc" });
      if (permission.state === "granted")
{
      ndef.onreading = event => 
      {

const decoder = new TextDecoder();
for (const record of event.message.records) {
  consoleLog("Record type:  " + record.recordType);
  consoleLog("MIME type:    " + record.mediaType);
  consoleLog("=== data ===\n" + decoder.decode(record.data));
}

};
} else 
{
console.log("NFC permission not granted");
}

});



</script>

<script>
var command = navigator.seService.createCommand();

  // initialize header bytes
  command.setHeaders(cla, ins, p1, p2);

  // set payload from byte array
  command.setPayload(payload);

  // and send it to the card
  channel.transmit(command, transmitcb, errorcb);

  // handle the response
  function transmitcb (response)
  {
    console.log("response status: " + to_hex(response.status) +
                " with " + response.payload.length + " bytes of data");

    // when done, break off connection to applet
    channel.close();
  }

  // called if transmit operation failed
  function errorcb (why)
  {
    console.log("couldn't transmit command to card: " + why);
  }



</script>

<script>

  try
{
  var successCB = function()
  {
    console.log("Sending APDU response was successful");
  };

  var errorCB = function()
  {
    console.log("Sending APDU response failed");
  };

  var classOfInstruction = 0x00;   /* No SM or no SM indication. */
  var instructionCode = 0xa4;      /* Select File. */
  var firstParam = 0x04;           /* Direct selection by DF name. */
  var secondParam = 0x00;          /* First record. */
  var dataFieldLength = 0x04;      /* Variable length 1 or 3 bytes. */
  var bytes = [0x01, 0x02, 0x03,0x04];  /* Variable length equal to dataFieldLength. */
  var maxBytesExpected = 0x00;     /* Maximum bytes in answer. */

  var apdu_response = [];
  apdu_response = apdu_response.concat([classOfInstruction], [instructionCode], [firstParam],
      [secondParam], [dataFieldLength], bytes,
      [maxBytesExpected]);  /* Sets apdu response. */
  adapter.sendHostAPDUResponse(apdu_response, successCB, errorCB);
}
catch (err)
{
  console.log(err.name + ": " + err.message);
}


function consoleLog(data) {
  var logElement = document.getElementById('log');
  logElement.innerHTML += data + '\n';
}
</script>



  </body>
  </html>

  
  
